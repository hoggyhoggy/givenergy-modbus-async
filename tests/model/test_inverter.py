import datetime

import pytest

from givenergy_modbus_async.model import TimeSlot
from givenergy_modbus_async.model.inverter import (
    BatteryCalibrationStage,
    BatteryPowerMode,
    BatteryType,
    Inverter,
    MeterType,
    Model,
    PowerFactorFunctionModel,
    Status,
    UsbDevice,
)
from givenergy_modbus_async.model.register_cache import RegisterCache


def test_inverter():
    i1 = Inverter()
    i2 = Inverter.from_orm(RegisterCache())

    assert (
        i1.dict()
        == i2.dict()
        == {
            'active_power_rate': None,
            'arm_firmware_version': None,
            'battery_calibration_stage': None,
            'battery_capacity': None,
            'battery_power_mode': None,
            'battery_type': None,
            'bms_firmware_version': None,
            'charge_slot_2': None,
            'charge_soc': None,
            'device_type_code': None,
            'discharge_slot_1': None,
            'discharge_slot_2': None,
            'discharge_soc': None,
            'dsp_firmware_version': None,
            'enable_60hz_freq_mode': None,
            'enable_ammeter': None,
            'enable_auto_judge_battery_type': None,
            'enable_charge_target': None,
            'enable_discharge': None,
            'enable_drm_rj45_port': None,
            'enable_inverter': None,
            'enable_inverter_auto_restart': None,
            'enable_reversed_115_meter': None,
            'enable_reversed_418_meter': None,
            'firmware_version': None,
            'first_battery_bms_firmware_version': None,
            'first_battery_serial_number': None,
            'grid_port_max_power_output': None,
            'meter_type': None,
            'modbus_address': None,
            'modbus_version': None,
            'model': None,
            'module': None,
            'num_mppt': None,
            'num_phases': None,
            'power_factor': None,
            'reactive_power_rate': None,
            'enable_reversed_ct_clamp': None,
            'select_arm_chip': None,
            'serial_number': None,
            'status': None,
            'system_time': None,
            'usb_device_inserted': None,
            'user_code': None,
            'variable_address': None,
            'variable_value': None,
            'v_pv_start': None,
            'restart_delay_time': None,
            'start_countdown_timer': None,
            'enable_charge': None,
            'charge_slot_1': None,
            'battery_high_voltage_protection_limit': None,
            'battery_low_voltage_protection_limit': None,
            # 'island_check_continue': None,
            'enable_buzzer': None,
            'enable_bms_read': None,
            'discharge_soc_stop_2': None,
            'charge_target_soc': None,
            'charge_soc_stop_2': None,
            'charge_soc_stop_1': None,
            'battery_soc_reserve': None,
            'battery_low_force_charge_time': None,
            'battery_discharge_min_power_reserve': None,
            'battery_discharge_limit': None,
            'battery_charge_limit': None,
            'debug_inverter': None,
            'discharge_soc_stop_1': None,
            'enable_above_6kw_system': None,
            'enable_battery_cable_impedance_alarm': None,
            'enable_battery_on_pv_or_grid': None,
            'enable_frequency_derating': None,
            'enable_g100_limit_switch': None,
            'enable_local_command_test': None,
            'enable_low_voltage_fault_ride_through': None,
            'enable_spi': None,
            'enable_ups_mode': None,
            'frequency_load_limit_rate': None,
            'power_factor_function_model': None,
            'start_system_auto_test': None,
            'threephase_abc': None,
            'threephase_balance_1': None,
            'threephase_balance_2': None,
            'threephase_balance_3': None,
            'threephase_balance_mode': None,
            'cmd_bms_flash_update': None,
            'enable_standard_self_consumption_logic': None,
            'e_battery_charge_today': None,
            'e_battery_charge_total2': None,
            'e_battery_discharge_today': None,
            'e_battery_discharge_total2': None,
            'pv_power_setting': None,
            'e_inverter_export_total': None,
        }
    )


def test_from_registers(register_cache):
    """Ensure we can return a dict view of inverter data."""
    i = Inverter.from_orm(register_cache)
    assert i.serial_number == 'SA1234G567'
    assert i.model == Model.HYBRID
    assert getattr(i, 'serial_number') == 'SA1234G567'
    with pytest.raises(TypeError, match="'Inverter' object is not subscriptable"):
        i['serial_number']

    assert i.dict() == {
        'battery_charge_limit': 50,
        'battery_discharge_limit': 50,
        'battery_discharge_min_power_reserve': 4,
        'battery_high_voltage_protection_limit': 58.50,
        'battery_low_force_charge_time': 6,
        'battery_low_voltage_protection_limit': 43.20,
        # 'battery_percent': 4,
        'battery_soc_reserve': 4,
        # 'battery_voltage_adjust': 0,
        'charge_slot_1': TimeSlot.from_repr(30, 430),
        'charge_soc_stop_1': 0,
        'charge_soc_stop_2': 0,
        # 'charge_status': 0,
        'charge_target_soc': 100,
        # 'charger_warning_code': 0,
        'cmd_bms_flash_update': None,
        # 'dci_1_i': 0.0,
        # 'dci_1_time': 0,
        # 'dci_2_i': 0.0,
        # 'dci_2_time': 0,
        # 'dci_fault_value': 0.0,
        'debug_inverter': None,
        'discharge_soc_stop_1': None,
        'discharge_soc_stop_2': 0,
        # 'e_battery_charge_day': 9.0,
        # 'e_battery_charge_day_2': 9.0,
        'e_battery_charge_today': None,
        # 'e_battery_charge_total': 174.4,
        'e_battery_charge_total2': None,
        # 'e_battery_discharge_day': 8.9,
        # 'e_battery_discharge_day_2': 8.9,
        'e_battery_discharge_today': None,
        # 'e_battery_discharge_total': 169.6,
        'e_battery_discharge_total2': None,
        # 'e_battery_throughput_total': 183.2,
        # 'e_discharge_year': 0.0,
        # 'e_grid_in_day': 20.9,
        # 'e_grid_in_total': 365.3,
        # 'e_grid_out_day': 0.0,
        # 'e_grid_out_total': 0.6,
        'e_inverter_export_total': None,
        # 'e_inverter_in_day': 9.3,
        # 'e_inverter_in_total': 94.6,
        # 'e_inverter_out_day': 8.1,
        # 'e_inverter_out_total': 93.0,
        # 'e_pv1_day': 0.4,
        # 'e_pv2_day': 0.5,
        # 'e_pv_day': 0.9,
        # 'e_pv_total': 15.9,
        # 'e_solar_diverter': 0.0,
        'enable_above_6kw_system': None,
        'enable_battery_cable_impedance_alarm': None,
        'enable_battery_on_pv_or_grid': None,
        'enable_bms_read': True,
        'enable_buzzer': False,
        'enable_charge': True,
        'enable_frequency_derating': None,
        'enable_g100_limit_switch': None,
        'enable_low_voltage_fault_ride_through': None,
        'enable_spi': None,
        'enable_standard_self_consumption_logic': None,
        'enable_ups_mode': None,
        # 'f_ac1': 49.9,
        # 'f_ac_fault_value': 0.0,
        # 'f_ac_high_c': 52.0,
        # 'f_ac_high_in': 52.0,
        # 'f_ac_high_in_time': 28,
        # 'f_ac_high_out': 51.98,
        # 'f_ac_high_out_time': 28,
        # 'f_ac_low_c': 47.0,
        # 'f_ac_low_in': 47.45,
        # 'f_ac_low_in_time': 1,
        # 'f_ac_low_out': 47.0,
        # 'f_ac_low_out_time': 24,
        # 'f_eps_backup': 49.86,
        # 'fault_code': 0,
        'frequency_load_limit_rate': None,
        # 'gfci_1_i': 0.0,
        # 'gfci_1_time': 0,
        # 'gfci_2_i': 0.0,
        # 'gfci_2_time': 0,
        # 'gfci_fault_value': 0.0,
        # 'grid_power_adjust': 0,
        # 'grid_r_voltage_adjust': 0,
        # 'grid_s_voltage_adjust': 0,
        # 'grid_t_voltage_adjust': 0,
        # 'i_ac1': 0.0,
        # 'i_battery': 0.0,
        # 'i_grid_port': 2.92,
        # 'i_pv1': 0.0,
        # 'i_pv2': 0.0,
        # 'inverter_countdown': 30,
        # 'inverter_reboot': 0,
        # 'inverter_status': 0,
        # 'island_check_continue': 0,
        # 'iso1': 0,
        # 'iso2': 0,
        # 'iso_fault_value': 0.0,
        'enable_local_command_test': None,
        # 'p_battery': 0,
        # 'p_eps_backup': 0,
        # 'p_grid_apparent': 680,
        # 'p_grid_out': -342,
        # 'p_inverter_out': 0,
        # 'p_load_demand': 342,
        # 'p_pv': 13,
        # 'p_pv1': 4,
        # 'p_pv2': 9,
        # 'pf_cmd_memory_state': False,
        # 'pf_inverter_out': -0.521,
        # 'pf_limit_lp1_lp': 0,
        # 'pf_limit_lp1_pf': -1.0,
        # 'pf_limit_lp2_lp': 0,
        # 'pf_limit_lp2_pf': -1.0,
        # 'pf_limit_lp3_lp': 0,
        # 'pf_limit_lp3_pf': -1.0,
        # 'pf_limit_lp4_lp': 0,
        # 'pf_limit_lp4_pf': -1.0,
        'power_factor_function_model': None,
        # 'pv1_power_adjust': 0,
        # 'pv1_voltage_adjust': 0,
        # 'pv2_power_adjust': 0,
        # 'pv2_voltage_adjust': 0,
        'pv_power_setting': None,
        'v_pv_start': 150.0,
        # 'real_v_f_value': 0.0,
        # 'remote_bms_restart': False,
        'restart_delay_time': 30,
        # 'safety_time_limit': 0.0,
        # 'safety_v_f_limit': 0.0,
        'start_countdown_timer': 30,
        'start_system_auto_test': None,
        # 'system_mode': 1,
        # 'temp_battery': 17.0,
        # 'temp_charger': 22.3,
        # 'temp_fault_value': 0.0,
        # 'temp_inverter_heatsink': 22.2,
        # 'test_treat_time': 0,
        # 'test_treat_value': 0.0,
        # 'test_value': 0.0,
        'threephase_abc': None,
        'threephase_balance_1': None,
        'threephase_balance_2': None,
        'threephase_balance_3': None,
        'threephase_balance_mode': None,
        # 'usb_device_inserted': 2,
        # 'v_10_min_protection': 274.0,
        # 'v_ac1': 236.7,
        # 'v_ac_fault_value': 0.0,
        # 'v_ac_high_c': 283.7,
        # 'v_ac_high_in': 262.0,
        # 'v_ac_high_in_time': 52,
        # 'v_ac_high_out': 274.0,
        # 'v_ac_high_out_time': 27,
        # 'v_ac_low_c': 175.5,
        # 'v_ac_low_in': 184.0,
        # 'v_ac_low_in_time': 126,
        # 'v_ac_low_out': 184.0,
        # 'v_ac_low_out_time': 126,
        # 'v_battery': 49.91,
        # 'v_eps_backup': 235.6,
        # 'v_highbrigh_bus': 12,
        # 'v_n_bus': 0.0,
        # 'v_p_bus': 7.0,
        # 'v_pv1': 1.4,
        # 'v_pv2': 1.0,
        # 'v_pv_fault_value': 0.0,
        # 'work_time_total': 213,
        'active_power_rate': 100,
        'arm_firmware_version': 449,
        'battery_calibration_stage': BatteryCalibrationStage.OFF,
        'battery_capacity': 160,
        'battery_power_mode': BatteryPowerMode.SELF_CONSUMPTION,
        'battery_type': BatteryType.LITHIUM,
        'bms_firmware_version': 101,
        'charge_slot_2': TimeSlot(datetime.time(0, 0), datetime.time(0, 4)),
        'charge_soc': 0,
        'device_type_code': '2001',
        'discharge_slot_1': TimeSlot.from_repr(0, 0),
        'discharge_slot_2': TimeSlot.from_repr(0, 0),
        'discharge_soc': 0,
        'dsp_firmware_version': 449,
        'enable_60hz_freq_mode': False,
        'enable_ammeter': True,
        'enable_auto_judge_battery_type': True,
        'enable_charge_target': True,
        'enable_discharge': False,
        'enable_drm_rj45_port': True,
        'enable_inverter': True,
        'enable_inverter_auto_restart': False,
        'enable_reversed_115_meter': False,
        'enable_reversed_418_meter': False,
        'enable_reversed_ct_clamp': True,
        'firmware_version': 'D0.449-A0.449',
        'first_battery_bms_firmware_version': 3005,
        'first_battery_serial_number': 'BG1234G567',
        'grid_port_max_power_output': 6000,
        'meter_type': MeterType.EM115,
        'modbus_address': 0x11,
        'modbus_version': '1.40',
        'model': Model.HYBRID,
        'module': '00030832',
        'num_mppt': 2,
        'num_phases': 1,
        'power_factor': 0,
        'reactive_power_rate': 0,
        'select_arm_chip': False,
        'serial_number': 'SA1234G567',
        'status': Status.WAITING,
        'system_time': datetime.datetime(2022, 1, 1, 23, 57, 19),
        'usb_device_inserted': UsbDevice.DISK,
        'user_code': 7,
        'variable_address': 32768,
        'variable_value': 30235,
    }


def test_from_registers_actual_data(register_cache_inverter_daytime_discharging_with_solar_generation):
    """Ensure we can instantiate an Inverter from actual register data."""
    i = Inverter.from_orm(register_cache_inverter_daytime_discharging_with_solar_generation)
    assert i.serial_number == 'SA1234G567'
    assert i.model == Model.HYBRID
    assert i.dict() == {
        'battery_charge_limit': 50,
        'battery_discharge_limit': 50,
        'battery_discharge_min_power_reserve': 4,
        'battery_high_voltage_protection_limit': 58.50,
        'battery_low_force_charge_time': 6,
        'battery_low_voltage_protection_limit': 43.20,
        # 'battery_percent': 68,
        'battery_soc_reserve': 4,
        # 'battery_voltage_adjust': 0,
        'charge_slot_1': TimeSlot.from_repr(30, 430),
        'charge_soc_stop_1': 0,
        'charge_soc_stop_2': 0,
        # 'charge_status': 5,
        'charge_target_soc': 100,
        # 'charger_warning_code': 0,
        'cmd_bms_flash_update': None,
        # 'dci_1_i': 0.0,
        # 'dci_1_time': 0,
        # 'dci_2_i': 0.0,
        # 'dci_2_time': 0,
        # 'dci_fault_value': 0.0,
        'debug_inverter': 0,
        'discharge_soc_stop_1': 0,
        'discharge_soc_stop_2': 0,
        # 'e_battery_charge_day': 9.1,
        # 'e_battery_charge_day_2': 9.1,
        'e_battery_charge_today': None,
        # 'e_battery_charge_total': 183.5,
        'e_battery_charge_total2': None,
        # 'e_battery_discharge_day': 3.4,
        # 'e_battery_discharge_day_2': 3.4,
        'e_battery_discharge_today': None,
        # 'e_battery_discharge_total': 173.0,
        'e_battery_discharge_total2': None,
        # 'e_battery_throughput_total': 356.5,
        # 'e_discharge_year': 0.0,
        # 'e_grid_in_day': 19.8,
        # 'e_grid_in_total': 624.2,
        # 'e_grid_out_day': 0.0,
        # 'e_grid_out_total': 0.9,
        'e_inverter_export_total': None,
        # 'e_inverter_in_day': 9.3,
        # 'e_inverter_in_total': 188.1,
        # 'e_inverter_out_day': 3.8,
        # 'e_inverter_out_total': 172.5,
        # 'e_pv1_day': 0.4,
        # 'e_pv2_day': 0.6,
        # 'e_pv_day': 1.0,
        # 'e_pv_total': 26.3,
        # 'e_solar_diverter': 0.0,
        'enable_above_6kw_system': False,
        'enable_battery_cable_impedance_alarm': False,
        'enable_battery_on_pv_or_grid': False,
        'enable_bms_read': True,
        'enable_buzzer': False,
        'enable_charge': True,
        'enable_frequency_derating': True,
        'enable_g100_limit_switch': False,
        'enable_low_voltage_fault_ride_through': False,
        'enable_spi': True,
        'enable_standard_self_consumption_logic': None,
        'enable_ups_mode': False,
        # 'f_ac1': 49.96,
        # 'f_ac_fault_value': 0.0,
        # 'f_ac_high_c': 52.0,
        # 'f_ac_high_in': 52.0,
        # 'f_ac_high_in_time': 28,
        # 'f_ac_high_out': 51.98,
        # 'f_ac_high_out_time': 28,
        # 'f_ac_low_c': 47.0,
        # 'f_ac_low_in': 47.45,
        # 'f_ac_low_in_time': 1,
        # 'f_ac_low_out': 47.0,
        # 'f_ac_low_out_time': 24,
        # 'f_eps_backup': 49.92,
        # 'fault_code': 0,
        'frequency_load_limit_rate': 24,
        # 'gfci_1_i': 0.0,
        # 'gfci_1_time': 0,
        # 'gfci_2_i': 0.0,
        # 'gfci_2_time': 0,
        # 'gfci_fault_value': 0.0,
        # 'grid_power_adjust': 0,
        # 'grid_r_voltage_adjust': 0,
        # 'grid_s_voltage_adjust': 0,
        # 'grid_t_voltage_adjust': 0,
        # 'i_ac1': 0.27,
        # 'i_battery': 6.47,
        # 'i_grid_port': 2.57,
        # 'i_pv1': 0.3,
        # 'i_pv2': 0.3,
        # 'inverter_countdown': 0,
        # 'inverter_status': 1,
        # 'island_check_continue': 0,
        # 'iso1': 0,
        # 'iso2': 0,
        # 'iso_fault_value': 0.0,
        'enable_local_command_test': False,
        # 'p_battery': 360,
        # 'p_eps_backup': 0,
        # 'p_grid_apparent': 554,
        # 'p_grid_out': 21,
        # 'p_inverter_out': 536,
        # 'p_load_demand': 515,
        # 'p_pv': 245,
        # 'p_pv1': 117,
        # 'p_pv2': 128,
        # 'pf_cmd_memory_state': True,
        # 'pf_inverter_out': -0.0469,
        # 'pf_limit_lp1_lp': 255,
        # 'pf_limit_lp1_pf': 1.0,
        # 'pf_limit_lp2_lp': 255,
        # 'pf_limit_lp2_pf': 1.0,
        # 'pf_limit_lp3_lp': 255,
        # 'pf_limit_lp3_pf': 1.0,
        # 'pf_limit_lp4_lp': 255,
        # 'pf_limit_lp4_pf': 1.0,
        'power_factor_function_model': PowerFactorFunctionModel.PF_1,
        # 'pv1_power_adjust': 0,
        # 'pv1_voltage_adjust': 0,
        # 'pv2_power_adjust': 0,
        # 'pv2_voltage_adjust': 0,
        'pv_power_setting': None,
        'v_pv_start': 150.0,
        # 'real_v_f_value': 0.0,
        # 'reboot': 0,
        # 'remote_bms_restart': False,
        'restart_delay_time': 30,
        # 'safety_time_limit': 0.0,
        # 'safety_v_f_limit': 0.0,
        'start_countdown_timer': 30,
        'start_system_auto_test': False,
        # 'system_mode': 1,
        # 'temp_battery': 16.0,
        # 'temp_charger': 24.1,
        # 'temp_fault_value': 0.0,
        # 'temp_inverter_heatsink': 24.4,
        # 'test_treat_time': 0,
        # 'test_treat_value': 0.0,
        # 'test_value': 0.0,
        'threephase_abc': 0,
        'threephase_balance_1': 0,
        'threephase_balance_2': 0,
        'threephase_balance_3': 0,
        'threephase_balance_mode': 0,
        # 'usb_device_inserted': 2,
        # 'user_code': 7,
        # 'v_10_min_protection': 274.0,
        # 'v_ac1': 236.3,
        # 'v_ac_fault_value': 0.0,
        # 'v_ac_high_c': 283.7,
        # 'v_ac_high_in': 262.0,
        # 'v_ac_high_in_time': 52,
        # 'v_ac_high_out': 274.0,
        # 'v_ac_high_out_time': 27,
        # 'v_ac_low_c': 175.5,
        # 'v_ac_low_in': 184.0,
        # 'v_ac_low_in_time': 126,
        # 'v_ac_low_out': 184.0,
        # 'v_ac_low_out_time': 126,
        # 'v_battery': 51.73,
        # 'v_eps_backup': 235.10,
        # 'v_highbrigh_bus': 2829,
        # 'v_n_bus': 0.0,
        # 'v_p_bus': 383.0,
        # 'v_pv1': 357.0,
        # 'v_pv2': 369.70,
        # 'v_pv_fault_value': 0.0,
        # 'work_time_total': 385,
        'active_power_rate': 100,
        'arm_firmware_version': 449,
        'battery_calibration_stage': BatteryCalibrationStage.OFF,
        'battery_capacity': 160,
        'battery_power_mode': BatteryPowerMode.SELF_CONSUMPTION,
        'battery_type': BatteryType.LITHIUM,
        'bms_firmware_version': 101,
        'charge_slot_2': TimeSlot(datetime.time(0, 0), datetime.time(0, 4)),
        'charge_soc': 0,
        'device_type_code': '2001',
        'discharge_slot_1': TimeSlot.from_repr(0, 0),
        'discharge_slot_2': TimeSlot.from_repr(0, 0),
        'discharge_soc': 0,
        'dsp_firmware_version': 449,
        'enable_60hz_freq_mode': False,
        'enable_ammeter': True,
        'enable_auto_judge_battery_type': True,
        'enable_charge_target': False,
        'enable_discharge': False,
        'enable_drm_rj45_port': True,
        'enable_inverter': True,
        'enable_inverter_auto_restart': False,
        'enable_reversed_115_meter': False,
        'enable_reversed_418_meter': False,
        'enable_reversed_ct_clamp': True,
        'firmware_version': 'D0.449-A0.449',
        'first_battery_bms_firmware_version': 3005,
        'first_battery_serial_number': 'BG1234G567',
        'grid_port_max_power_output': 6000,
        'meter_type': MeterType.EM115,
        'modbus_address': 0x11,
        'modbus_version': '1.40',
        'model': Model.HYBRID,
        'module': '00030832',
        'num_mppt': 2,
        'num_phases': 1,
        'power_factor': 0,
        'reactive_power_rate': 0,
        'select_arm_chip': False,
        'serial_number': 'SA1234G567',
        'status': Status.NORMAL,
        'system_time': datetime.datetime(2022, 1, 11, 11, 51, 46),
        'usb_device_inserted': UsbDevice.DISK,
        'user_code': 7,
        'variable_address': 32768,
        'variable_value': 30235,
    }
